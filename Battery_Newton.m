%%  Tremblay’smodel, the battery voltage during the discharge
%% Li-ion battery dynamics model parameter estimation using datasheets and particle swarm optimization Yong Wang1 and Lin Li2,*,† 1Department of Systems Science and Industrial Engineering, Binghamton University, Binghamton, NY 13902, USA 2Department of Mechanical and Industrial Engineering, University of Illinois at Chicago, Chicago, IL 60607, USA
%  programmer:                                                                                                                                                                                         %       
%                              **             %%                      Mohamed Ibrahim Zineldin                      %%             **                                           %    
%                                                                        e-Mail: mozain361@gmail.com                                                                                    %     
%                                                                                   Under  Supervision of                                                                                         %        
%                              **             %%                               DR. Rizk M Rizk Allah                             %%             **                                     %                            
%                                                                        e-Mail: rizk_masoud@yahoo.com                                                                                %          
%                                                                                    -----------------------                                                                                            %             
function [V,IAES,RSS,RMSE]=Battery_Newton(A,B,U0,K,R,Q,V_mes,T,I)
%[V,IAES,RSS,RMSE]=Battery(0.15336, 3.6628, 3.46125, 0.00101, 0.01748, 22.507)
%% function [V,IAES,RSS]=Battery(a,b,c,U0,R,Q,V_mes,T)
%V    is the battary voltage(V),
%U0 the battary  constant voltage(V), 
%K     polarization voltage(V)
%Q    is the battary capacity (Ah),
%a     is the exponential zone amplitude (V), 
%b     is the exponential zone time constant inverse (Ah)-1,
%R     is the internal resistance (?), 
% A=0.15336;
% B=3.6628;
% U0=3.46125;
% K=0.00101;
% R=0.01748;
% Q=22.507;
%% The Specification of the Tested Battery:
%V_mes=Voltage_measured 
%Example 2
% V_mes=[3.42910000000000,3.40230000000000,3.37890000000000,3.35540000000000,3.33530000000000,3.30520000000000,3.28840000000000,3.27840000000000,3.27840000000000,3.27840000000000,3.27840000000000,3.27840000000000,3.27500000000000,3.27170000000000,3.27170000000000,3.27170000000000,3.27170000000000,3.27170000000000,3.27170000000000,3.27170000000000,3.27170000000000,3.27170000000000,3.27170000000000,3.27170000000000,3.26830000000000,3.26830000000000,3.26830000000000,3.26830000000000,3.26830000000000,3.26830000000000,3.26830000000000,3.26830000000000,3.26830000000000,3.26830000000000,3.26500000000000,3.26500000000000,3.26500000000000,3.26500000000000,3.25490000000000,3.25490000000000,3.25490000000000,3.25490000000000,3.25490000000000,3.25490000000000,3.25490000000000,3.24820000000000,3.24490000000000,3.24490000000000,3.24490000000000,3.24490000000000,3.24490000000000,3.24490000000000,3.24490000000000,3.24150000000000,3.23480000000000,3.23480000000000,3.24150000000000,3.24150000000000,3.24150000000000,3.24150000000000,3.24150000000000,3.23820000000000,3.23480000000000,3.23480000000000,3.23480000000000,3.23480000000000,3.23820000000000,3.23480000000000,3.23480000000000,3.23480000000000,3.23480000000000,3.23150000000000,3.23150000000000,3.23150000000000,3.23150000000000,3.23150000000000,3.23150000000000,3.22480000000000,3.21810000000000,3.21810000000000,3.21810000000000,3.21810000000000,3.21810000000000,3.21810000000000,3.21470000000000,3.21470000000000,3.21470000000000,3.21140000000000,3.21140000000000,3.21140000000000,3.20470000000000,3.20470000000000,3.20130000000000,3.20130000000000,3.19800000000000,3.19800000000000,3.19460000000000,3.18790000000000,3.18460000000000,3.18460000000000,3.17790000000000,3.17450000000000,3.16780000000000,3.16110000000000,3.15780000000000,3.15110000000000,3.14440000000000,3.14100000000000,3.13430000000000,3.13100000000000,3.12760000000000,3.12090000000000,3.11090000000000,3.10420000000000,3.09080000000000,3.08070000000000,3.05730000000000,3.03380000000000,3.01370000000000,2.98360000000000,2.95340000000000,2.93330000000000,2.91660000000000,2.89980000000000,2.86970000000000,2.85290000000000,2.82610000000000,2.80940000000000,2.78260000000000,2.75580000000000,2.72900000000000,2.71220000000000,2.68540000000000,2.66530000000000,2.63520000000000,2.61170000000000,2.58160000000000,2.57150000000000,2.52130000000000,2.50450000000000,2.47100000000000,2.45430000000000,2.42750000000000,2.41410000000000,2.38730000000000,2.34710000000000,2.28340000000000,2.26000000000000,2.22650000000000,2.17960000000000,2.14940000000000,2.11930000000000,2.08580000000000,2.02550000000000,2.05560000000000,2];
n=size(V_mes,2); % the number of experimental data
% I(t) is the battery current (A) at time t
% I=10;%Discharge current (A)= 10 (Constantant)
%T= is a time constant.
%T=[0,0.00910000000000000,0.0122000000000000,0.0213000000000000,0.0274000000000000,0.0365000000000000,0.0517000000000000,0.0760000000000000,0.0973000000000000,0.121700000000000,0.139900000000000,0.161200000000000,0.188600000000000,0.215900000000000,0.237200000000000,0.252400000000000,0.261600000000000,0.285900000000000,0.313300000000000,0.334500000000000,0.349800000000000,0.361900000000000,0.371000000000000,0.380200000000000,0.392300000000000,0.413600000000000,0.431900000000000,0.444000000000000,0.453200000000000,0.462300000000000,0.471400000000000,0.480500000000000,0.495700000000000,0.507900000000000,0.523100000000000,0.532200000000000,0.544400000000000,0.553500000000000,0.580900000000000,0.602200000000000,0.623500000000000,0.641700000000000,0.653900000000000,0.663000000000000,0.681300000000000,0.705600000000000,0.733000000000000,0.754300000000000,0.775500000000000,0.790800000000000,0.799900000000000,0.815100000000000,0.833300000000000,0.845500000000000,0.863700000000000,0.882000000000000,0.909400000000000,0.930700000000000,0.945900000000000,0.964100000000000,0.988400000000000,1.01580000000000,1.03710000000000,1.04930000000000,1.06450000000000,1.07660000000000,1.09180000000000,1.11010000000000,1.12230000000000,1.13140000000000,1.14660000000000,1.16180000000000,1.18000000000000,1.19220000000000,1.20130000000000,1.21350000000000,1.23780000000000,1.25000000000000,1.26520000000000,1.27740000000000,1.30470000000000,1.33210000000000,1.35340000000000,1.37170000000000,1.39290000000000,1.40820000000000,1.42030000000000,1.44160000000000,1.46590000000000,1.48720000000000,1.51160000000000,1.52070000000000,1.54810000000000,1.55410000000000,1.58150000000000,1.60890000000000,1.63020000000000,1.64840000000000,1.66360000000000,1.69100000000000,1.71840000000000,1.74570000000000,1.76700000000000,1.79440000000000,1.82180000000000,1.84310000000000,1.85830000000000,1.87960000000000,1.89170000000000,1.90690000000000,1.91610000000000,1.93130000000000,1.95860000000000,1.97080000000000,1.98910000000000,2.00730000000000,2.02860000000000,2.04080000000000,2.04990000000000,2.06200000000000,2.07420000000000,2.08030000000000,2.08330000000000,2.08640000000000,2.09550000000000,2.09850000000000,2.10160000000000,2.10460000000000,2.11070000000000,2.11370000000000,2.11980000000000,2.12290000000000,2.12590000000000,2.12900000000000,2.13500000000000,2.13810000000000,2.14420000000000,2.14420000000000,2.15020000000000,2.15020000000000,2.15330000000000,2.15940000000000,2.16240000000000,2.16240000000000,2.16550000000000,2.16850000000000,2.17760000000000,2.18070000000000,2.18370000000000,2.18980000000000,2.19280000000000,2.19890000000000,2.20190000000000,2.20500000000000,2.20500000000000,2.20800000000000];
% D= 0.785278120878519 ;%(Capacity(Ahr))D is the discharged capacity at time t =Battery capacity (Ahr) for discharge till 2.7V 
%% Objective function
D=I*T;
t=1; %t=battery response time (s)=*1/3600(h)
Ifit=I*(1-exp(-T/t)); %the filtered current(first order step response) at time
% V=U0-(R*I)-(K*Q*D)*1./(Q-D)-(K*Q*Ifit)*1./(Q-D)+A*exp(-B*D);
% Newton-Raphson Method:
V=zeros(size(V_mes));
for i=1:5
    F=U0-(R*I)-(K*Q*D)*1./(Q-D)-(K*Q*Ifit)*1./(Q-D)+A*exp(-B*D)-V;  %F= The function of Voltage [V] difference 
    dF=-2;                                                          %     %dF=F' is the first differentiationof function F with respect to V
    V=V-F./dF;
end

IAES=abs(V-V_mes);%absolute error
RSS=sum(((V-V_mes)).^2); %the residual sum of squares 
RMSE=sqrt(sum(((V-V_mes)).^2))/n; %root mean square error
%% Results
% figure
% axes2 = axes('OuterPosition',[0 0 1 1]);
% plot (T,V,'Parent',axes2,'LineWidth',1.5);
% title('VOLTAG-TIME Discharge Curve ');
% xlabel('Time(h)');
% ylabel('Voltage (V))');
% hold all                 % to plot two curves on the same coordinates graph
% plot(T,V_mes)
end